<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>map.simonwillison.net</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
  <!-- Gesture Handling Plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css" type="text/css">
  <script src="https://unpkg.com/leaflet-gesture-handling"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    function toPoint(s) {
      return s.split(",").map(parseFloat);
    }

    async function load() {
      let params = new URLSearchParams(location.search);
      let center = params.get('center') || '0,0';
      let initialZoom = params.get('zoom');
      let zoom = parseInt(initialZoom || '2', 10);
      let q = params.get('q');
      let markers = params.getAll('marker');
      
      let map = L.map('map', { zoomControl: true, gestureHandling: true }).setView(toPoint(center), zoom);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20,
        detectRetina: true
      }).addTo(map);

      fetch("https://raw.githubusercontent.com/ColeBoelterGIS/heirloom-url-map/main/Stillwater.geojson")
        .then(response => response.json())
        .then(data => {
          L.geoJSON(data, {
            style: function (feature) {
              return { color: "#000000", fillOpacity: 0 };
            }
          }).addTo(map);
        });

      const arcgisFeatureLayerURL = 'https://services3.arcgis.com/eUyz58xtA1naNJoX/arcgis/rest/services/Parcels/FeatureServer/0';
      L.esri.featureLayer({
        url: arcgisFeatureLayerURL,
        minZoom: 18,
        style: function (feature) {
          return {
            color: '#d4d4d4',
            weight: 1,
            fill: false
          };
        }
      }).addTo(map);

      if (q && !params.get('center')) {
        let response = await fetch(`https://nominatim.openstreetmap.org/search.php?q=${encodeURIComponent(q)}&format=jsonv2`);
        let data = await response.json();
        let bounds = [
          [data[0].boundingbox[0], data[0].boundingbox[2]],
          [data[0].boundingbox[1], data[0].boundingbox[3]]
        ];
        map.fitBounds(bounds);
        if (initialZoom) {
          map.setZoom(parseInt(initialZoom));
        }
      }

      map.on('moveend zoomend', () => {
        let newZoom = map.getZoom();
        let center = map.getCenter();
        let u = new URLSearchParams();
        markers.forEach(s => u.append('marker', s));
        u.append('center', `${center.lat},${center.lng}`);
        u.append('zoom', newZoom);
        history.replaceState(null, null, '?' + u.toString());
      });
      }
      markers.forEach(s => {
        L.marker(toPoint(s)).addTo(map);
      });
    }
    load();
  </script>
</body>
</html>
